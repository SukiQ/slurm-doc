# 概览

Slurm 具有三个关键功能：

- 在一段时间内为用户分配对资源的独占和/或非独占访问权
- 它提供了一个框架，用于在分配的节点集上启动、执行和监视工作
- 它通过管理挂起的工作队列来仲裁资源争用

<img src="overview-0.png" alt="image.png" width="700" />

## 术语

- Node：节点，Slurm 中的计算资源

- partition：分区，节点分组的逻辑集，分区可视为作业队列，每个队列都有各种约束，如作业大小限制、作业时间限制、允许使用的用户等

- job：作业，在指定的时间内分配给用户的资源分配

- job step：作业步骤，作业内的一组任务

- het job：异构作业，异构作业由多个作业组件组成，每个作业组件都可以有单独的作业选项和资源分配

- job array：作业数组提供了一种快速、轻松地提交和管理类似作业集合的机制



## 生命周期（sbatch）

1. 用户提交一个作业到slurmctld

2. slurmctld通过分区管理器（Partition Manager）查询该作业是否能够运行，如果用户请求了一个不存在的分区或约束，分区管理器会返回错误，丢弃该请求

   ```bash
   Error: Requested partition does not exist.
   ```

3. 在成功提交后，slurmctld会为作业分配一个唯一的 **job-id**，将其添加到作业队列中，并将job-id返回给用户，用户会收到成功信息并退出

   ```bash
   Submitted batch job 42
   ```

4. slurmctld唤醒作业管理器，作业管理器会按照**优先级**先后进行排序并准备执行作业

5. 作业管理器向分区管理器请求分配的节点，并向分配的节点发送作业请求，作业请求中除了执行脚本外还包含环境变量，工作目录，输入输出位置等参数

6. 远程节点建立新的环境，作为root用户执行Slurm的Prolog程序（如果已配置），然后以提交用户的身份执行作业脚本

7. 当任务完成执行时，远程节点会通知作业管理器任务为退出状态，并开始清理



## 守护进程

### slurmctld

控制进程，负责资源状态维护、资源分配、作业调度、作业管理控制等

- 节点管理器（Node Manager）: 负责监视集群中每个节点的状态，周期性地检查slurmd的信息，并异步地从slurmd接受更新后的配置信息
- 分区管理器（Partition Manager）: 负责为作业分配分区，分区管理器在作业请求时为待处理作业分配节点
- 作业管理器（Job Manager）: 负责接受用户的作业请求，并根据调度算法和优先级决定是否对作业执行挂起、执行、完成等操作

### slurmd

节点监控进程，运行在每个计算节点上，负责收集节点上的资源状态并向控制进程报告，组件包括包括：

- 与slurmctld交互组件

- 启动，管理，删除作业组件

- 错误输入输出处理组件
- 远程交互组件

### slurmdbd

slurm 数据库守护进程，提供访问缓存数据与关联信息的统一接口，并起到用户认证与安全隔离的作用

### slurmrestd

API接口进程，允许客户端通过rest api与slurm通信

### munge

身份验证服务，确保集群中的所有节点都具有相同的`munge.key`

### sackd

<note>
   slurm 24.05.2+
</note>

新的身份验证进程，作为munge的替代